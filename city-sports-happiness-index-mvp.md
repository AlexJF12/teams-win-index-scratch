
# üèôÔ∏è City Sports Happiness Index ‚Äì MVP Plan

A Python-first, CSV-only project that calculates how "happy" a city's sports fans should feel based on outcomes of games played by teams in that city. Outputs a static website (no backend) that can be hosted on GitHub Pages. Daily updates run via GitHub Actions.

---

## üéØ Goals
- **All data** stored as CSVs in-repo
- **Computation** done in Python (pandas)
- **Output** is a static site in `docs/` (HTML files + assets)
- **Scheduling** via GitHub Actions (no servers)
- **Frontend** is minimal static HTML generated by Jinja2 + Plotly (offline)

---

## üß† Scoring Rules (configurable)
- **Regular Season Win**: +1 point
- **Regular Season Loss**: ‚Äì1 point
- **Playoff Win**: +3 points
- **Playoff Loss**: ‚Äì3 points

These weights will live in a small YAML/JSON config (e.g., `config/scoring.json`) so they can be adjusted without changing code.

---

## üß± Architecture
- **Data source**: Historical CSVs (Kaggle/Sports Reference) + daily results via TheSportsDB API
- **Storage**: CSVs only, committed to the repo
- **Processing**: Python scripts orchestrated by a single `update_and_build.py`
- **Site generation**: Jinja2 to render static HTML; Plotly offline for charts
- **Hosting**: GitHub Pages serving the `docs/` directory
- **Scheduling**: GitHub Actions (cron) runs daily, commits updated CSVs + rebuilt site

---

## üóÇÔ∏è Repository layout
```text
.
‚îú‚îÄ config/
‚îÇ  ‚îú‚îÄ scoring.json                # Points for win/loss/playoff; season dates if needed
‚îÇ  ‚îî‚îÄ leagues.json                # Which leagues to include, basic metadata
‚îú‚îÄ data/
‚îÇ  ‚îú‚îÄ raw/                        # As-downloaded league CSVs (by league/year)
‚îÇ  ‚îú‚îÄ processed/
‚îÇ  ‚îÇ  ‚îú‚îÄ teams.csv                # Canonical teams with city mapping
‚îÇ  ‚îÇ  ‚îú‚îÄ cities.csv               # Canonical list of cities
‚îÇ  ‚îÇ  ‚îî‚îÄ games.csv                # Normalized game rows across leagues
‚îÇ  ‚îú‚îÄ daily/
‚îÇ  ‚îÇ  ‚îî‚îÄ YYYY-MM-DD.csv           # Appended daily results from APIs
‚îÇ  ‚îî‚îÄ outputs/
‚îÇ     ‚îú‚îÄ city_scores.csv          # Daily city happiness index (full history)
‚îÇ     ‚îî‚îÄ city_scores_latest.csv   # Snapshot for yesterday
‚îú‚îÄ docs/                          # Static site (GitHub Pages root)
‚îÇ  ‚îú‚îÄ index.html                  # Landing: yesterday‚Äôs leaderboard + city picker
‚îÇ  ‚îú‚îÄ cities/
‚îÇ  ‚îÇ  ‚îî‚îÄ {city-slug}.html         # One page per city with historical chart
‚îÇ  ‚îî‚îÄ assets/                     # CSS/JS (Plotly bundle) + favicon
‚îú‚îÄ scripts/
‚îÇ  ‚îú‚îÄ seed_cities_and_teams.py    # Build cities.csv + teams.csv mapping
‚îÇ  ‚îú‚îÄ load_historical_{league}.py  # Normalize raw historical CSVs to processed/games.csv
‚îÇ  ‚îú‚îÄ fetch_yesterday.py          # Pull prior-day results from TheSportsDB
‚îÇ  ‚îú‚îÄ calc_city_scores.py         # Compute daily city scores from games.csv
‚îÇ  ‚îú‚îÄ generate_site.py            # Render HTML pages into docs/
‚îÇ  ‚îî‚îÄ update_and_build.py         # Orchestrate fetch -> recompute -> generate
‚îú‚îÄ requirements.txt
‚îú‚îÄ README.md
‚îî‚îÄ .github/workflows/daily.yml    # GitHub Actions schedule
```

---

## üìÑ CSV Schemas
- `processed/cities.csv`
  - `city_id`, `city_name`, `state`, `country`, `slug`
- `processed/teams.csv`
  - `team_id`, `team_name`, `league`, `city_id`, `city_name`, `start_date`, `end_date`, `alt_names`
- `processed/games.csv` (normalized across leagues)
  - `game_id`, `date` (YYYY-MM-DD), `league`, `season_type` (regular|playoff),
    `home_team_id`, `away_team_id`, `home_score`, `away_score`, `winning_team_id`
- `daily/YYYY-MM-DD.csv` (API snapshot per day)
  - Same columns as `processed/games.csv` for that day
- `outputs/city_scores.csv`
  - `date`, `city_id`, `city_name`, `score`, `wins`, `losses`, `playoff_wins`, `playoff_losses`

---

## üß∞ Python Tooling
- `pandas`, `requests`, `python-dateutil`, `jinja2`, `plotly`
- Optional: `ruff` (lint), `black` (format)

`requirements.txt` minimal:
```txt
pandas==2.2.2
requests==2.32.3
python-dateutil==2.9.0.post0
Jinja2==3.1.4
plotly==5.22.0
```

---

## üñ•Ô∏è Frontend (static, minimal)
- `index.html` shows:
  - Yesterday‚Äôs date
  - City leaderboard (top N) from `city_scores_latest.csv`
  - List of all cities linking to `/cities/{city-slug}.html`
- `cities/{city-slug}.html` shows:
  - City summary counts (wins/losses/score for yesterday)
  - Plotly offline time-series chart of last 365 days from `outputs/city_scores.csv`
- Styling: keep minimal; optionally include a tiny CSS like Pico.css or just basic CSS

All HTML is rendered by `scripts/generate_site.py` using Jinja2 templates (stored inline or in `templates/`). Plotly is included through its offline JS bundle copied into `docs/assets/`.

---

## üîÅ Daily Update Flow
1. GitHub Actions triggers daily (UTC morning)
2. `scripts/update_and_build.py` runs:
   - Fetch prior day results ‚Üí `data/daily/YYYY-MM-DD.csv`
   - Append to `processed/games.csv` if new
   - Recalculate `outputs/city_scores.csv`
   - Write `outputs/city_scores_latest.csv`
   - Regenerate `docs/` HTML
3. Commit and push changes to `data/` and `docs/`
4. GitHub Pages serves the updated static site

---

## ‚öôÔ∏è GitHub Actions (copy-paste)
Create `.github/workflows/daily.yml`:
```yaml
name: Daily Update and Build

on:
  schedule:
    - cron: '15 9 * * *'  # 09:15 UTC daily
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to push to the repo
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run update and build
        env:
          THESPORTSDB_API_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        run: |
          python scripts/update_and_build.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          git commit -m "chore: daily data + site update" || echo "No changes to commit"
          git push
```
Enable GitHub Pages to serve the `docs/` folder (Settings ‚Üí Pages ‚Üí Build and deployment ‚Üí Deploy from a branch ‚Üí `main`/`docs`).

---

## üîå Data Sources
- **Historical**: Download CSVs per league (Kaggle, Sports Reference). Save to `data/raw/{league}/`.
- **Daily**: TheSportsDB API. Use free endpoints to query yesterday‚Äôs events by league.
  - Store API key in repo secret `THESPORTSDB_API_KEY` if required by chosen endpoints.

Daily fetch strategy in `fetch_yesterday.py`:
- Resolve yesterday in Eastern Time (or desired TZ)
- For each configured league, fetch events for that date
- Normalize to `games.csv` schema

---

## üßÆ Calculation Details
- Determine a game‚Äôs city for each team by looking up `teams.csv ‚Üí city_id`
- For each city-date pair, compute:
  - `wins`, `losses`, `playoff_wins`, `playoff_losses`
  - `score = wins - losses + 3*playoff_wins - 3*playoff_losses` (from `config/scoring.json`)
- Append/overwrite rows for that date in `outputs/city_scores.csv`

---

## üèÅ Cursor Agent Quickstart
- **Bootstrap environment**
  - Create venv and install deps
  - Create initial `config/scoring.json` and `config/leagues.json`
- **Seed canonical data**
  - Run `seed_cities_and_teams.py` to produce `processed/cities.csv` and `processed/teams.csv`
- **Load historical data**
  - Place raw CSVs into `data/raw/{league}/` and run `load_historical_{league}.py`
  - Run `calc_city_scores.py` to generate `outputs/city_scores.csv`
- **Generate site**
  - Run `generate_site.py` to write `docs/`
- **Daily automation**
  - Add `THESPORTSDB_API_KEY` secret
  - Commit `.github/workflows/daily.yml` and enable GitHub Pages

Suggested commands (local):
```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python scripts/seed_cities_and_teams.py
python scripts/load_historical_nba.py   # repeat per league
python scripts/calc_city_scores.py
python scripts/generate_site.py
python -m http.server --directory docs 8000  # preview at http://localhost:8000
```

---

## ‚úÖ MVP Scope Checklist
- [ ] `requirements.txt`, `config/` scaffolding
- [ ] `processed/cities.csv` and `processed/teams.csv` seeds
- [ ] `processed/games.csv` from at least one league (historical)
- [ ] `outputs/city_scores.csv` computed for last year
- [ ] `docs/index.html` + a few `docs/cities/*.html` generated
- [ ] Daily GitHub Action scheduled and pushes changes
- [ ] GitHub Pages enabled, site live

---

## üß∞ Optional Enhancements
- Add per-league toggles on city pages
- Add rolling-average or z-score variants of the happiness index
- Add downloadable CSV links on each city page
- Add a simple JSON API snapshot in `docs/api/` for programmatic consumption
